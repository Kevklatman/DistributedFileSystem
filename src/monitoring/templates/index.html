<!DOCTYPE html>
<html>
<head>
    <title>DFS Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            margin-bottom: 20px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .env-label {
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 10px;
        }
        .env-label a {
            color: inherit;
            text-decoration: none;
        }
        .env-label a:hover {
            text-decoration: underline;
        }
        .prod {
            background-color: #28a745;
            color: white;
        }
        .dev {
            background-color: #ffc107;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-body">
                <h1 class="mb-3">Distributed File System Dashboard</h1>
                <div class="d-flex">
                    <div class="env-label prod">
                        Production UI: <a href="http://localhost:3000" target="_blank">localhost:3000</a>
                    </div>
                    <div class="env-label dev">
                        Development UI: <a href="http://localhost:5555" target="_blank">localhost:5555</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- Storage Overview -->
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-header">
                        <h5>Storage Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Total Storage</h6>
                                <p id="total-storage">Loading...</p>
                            </div>
                            <div class="col-md-4">
                                <h6>Used Storage</h6>
                                <p id="used-storage">Loading...</p>
                            </div>
                            <div class="col-md-4">
                                <h6>Available</h6>
                                <p id="available-storage">Loading...</p>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="storage-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network I/O -->
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-header">
                        <h5>Network I/O</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Bytes In</h6>
                                <p id="bytes-in">Loading...</p>
                            </div>
                            <div class="col-md-4">
                                <h6>Bytes Out</h6>
                                <p id="bytes-out">Loading...</p>
                            </div>
                            <div class="col-md-4">
                                <h6>Total</h6>
                                <p id="total-bytes">Loading...</p>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="network-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request Latency -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card metric-card">
                    <div class="card-header">
                        <h5>Request Latency</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="latency-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pod Status -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card metric-card">
                    <div class="card-header">
                        <h5>Pod Status</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Pod Name</th>
                                    <th>Status</th>
                                    <th>IP</th>
                                    <th>Node</th>
                                    <th>Start Time</th>
                                </tr>
                            </thead>
                            <tbody id="pod-status">
                                <tr>
                                    <td colspan="5">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let storageChart = null;
        let networkChart = null;
        let latencyChart = null;

        function initCharts() {
            // Storage Chart
            const storageCtx = document.getElementById('storage-chart').getContext('2d');
            storageChart = new Chart(storageCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Available'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#dc3545', '#28a745']
                    }]
                }
            });

            // Network Chart
            const networkCtx = document.getElementById('network-chart').getContext('2d');
            networkChart = new Chart(networkCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Bytes In',
                        data: [],
                        borderColor: '#007bff'
                    }, {
                        label: 'Bytes Out',
                        data: [],
                        borderColor: '#28a745'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Latency Chart
            const latencyCtx = document.getElementById('latency-chart').getContext('2d');
            latencyChart = new Chart(latencyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Request Latency (ms)',
                        data: [],
                        backgroundColor: '#17a2b8'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateMetrics() {
            fetch('/api/metrics')
                .then(response => response.json())
                .then(data => {
                    // Update Storage
                    document.getElementById('total-storage').textContent = data.storage.total_storage;
                    document.getElementById('used-storage').textContent = data.storage.used_storage;
                    document.getElementById('available-storage').textContent = data.storage.available_storage;

                    // Update Storage Chart
                    const used = parseFloat(data.storage.used_storage);
                    const available = parseFloat(data.storage.available_storage);
                    storageChart.data.datasets[0].data = [used, available];
                    storageChart.update();

                    // Update Network I/O
                    document.getElementById('bytes-in').textContent = data.network.bytes_in;
                    document.getElementById('bytes-out').textContent = data.network.bytes_out;
                    document.getElementById('total-bytes').textContent = data.network.total_bytes;

                    // Update Network Chart
                    const timestamp = new Date().toLocaleTimeString();
                    networkChart.data.labels.push(timestamp);
                    networkChart.data.datasets[0].data.push(parseFloat(data.network.bytes_in));
                    networkChart.data.datasets[1].data.push(parseFloat(data.network.bytes_out));
                    if (networkChart.data.labels.length > 10) {
                        networkChart.data.labels.shift();
                        networkChart.data.datasets[0].data.shift();
                        networkChart.data.datasets[1].data.shift();
                    }
                    networkChart.update();

                    // Update Latency Chart
                    latencyChart.data.labels = data.latency.map(l => `${l.method} ${l.endpoint}`);
                    latencyChart.data.datasets[0].data = data.latency.map(l => parseFloat(l.latency));
                    latencyChart.update();

                    // Update Pod Status
                    const podStatus = document.getElementById('pod-status');
                    podStatus.innerHTML = data.pods.map(pod => `
                        <tr>
                            <td>${pod.name}</td>
                            <td><span class="badge ${pod.status === 'Running' ? 'bg-success' : 'bg-danger'}">${pod.status}</span></td>
                            <td>${pod.ip}</td>
                            <td>${pod.node}</td>
                            <td>${pod.start_time}</td>
                        </tr>
                    `).join('');
                })
                .catch(error => console.error('Error fetching metrics:', error));
        }

        // Initialize charts and start polling
        initCharts();
        updateMetrics();
        setInterval(updateMetrics, 5000);
    </script>
</body>
</html>
